# 项目改进计划与分析报告

**版本**: 1.2
**日期**: 2025-09-10
**状态**: 进行中

---

## 1. 引言

本文档旨在全面分析 `mdtowechat` 项目的现有代码库，识别潜在的改进点，并制定一个分阶段的、可执行的优化计划。目标是提升应用性能、代码质量、健壮性和长期可维护性。所有任务将以待办清单的形式进行跟踪。

---

## 2. 现有代码分析总结

### 2.1. `core/wechat_api.py` (微信API交互)

*   **优点**:
    *   封装了完整的微信API调用，逻辑清晰。
    *   实现了 `access_token` 的缓存和自动刷新机制。
    *   对 `access_token` 过期等特定错误有基本的重试逻辑。
*   **待改进**:
    *   **[性能瓶颈] 同步阻塞**: 所有网络请求均使用同步的 `requests` 库，在GUI应用中会导致界面冻结（UI假死）。
    *   **[健壮性] 低效的素材查找**: `find_media_id_by_url` 通过遍历线上所有素材来查找 `media_id`，效率极低。
    *   **[健壮性] 递归重试**: 使用递归进行API重试，存在栈溢出风险。

### 2.2. `core/renderer.py` (Markdown渲染器)

*   **优点**:
    *   **[核心亮点] 强大的微信列表兼容性**: `_process_lists` 函数通过精细的DOM操作，完美解决了Markdown列表在微信编辑器中的显示问题。
    *   **[扩展性] 模块化主题系统**: 样式和逻辑分离，易于扩展新主题。
    *   **[视觉效果] 美观的代码块**: 为代码块自动添加了macOS风格的窗口装饰。
*   **待改进**:
    *   **[代码质量] 代码重复**: 文件中存在一个完全重复的 `_apply_theme_styles` 方法。
    *   **[性能/可维护性] 低效的代码高亮**: 使用内联样式 (`noclasses=True`) 生成代码高亮，导致HTML体积庞大且难以维护。
    *   **[可维护性] 硬编码样式**: macOS窗口样式等CSS代码硬编码在Python字符串中，不利于修改。
    *   **[功能不完整] 目录(TOC)处理**: 未明确处理 `[TOC]` 的生成和渲染逻辑。

### 2.3. 整体项目结构

*   **优点**:
    *   项目结构清晰，模块划分合理。
    *   `README.md` 和 `requirement.md` (需求文档) 提供了丰富的信息。
*   **待改进**:
    *   **[可维护性] 缺少自动化测试**: 项目没有单元测试或集成测试，增加了回归风险。
    *   **[规范性] 文档命名**: `requirement.md` 应更名为更具描述性的名称，如 `SPECIFICATION.md`。

---

## 3. 待办事项清单 (To-Do List)

### **阶段 0: 准备工作**
- [x] 创建 `IMPROVEMENT_PLAN.md` 文件并将本内容写入。

### **阶段 1: 渲染器优化**
- [ ] **1.1.** 删除 `core/renderer.py` 中重复的 `_apply_theme_styles` 方法。
- [ ] **1.2.** 优化代码高亮：
    - [ ] a. 修改 `codehilite` 扩展配置为 `noclasses=False`。
    - [ ] b. 将 `pygments` 的CSS样式整合到 `styles.py` 中。
- [ ] **1.3.** 分离样式与逻辑：将 `_apply_mac_style_to_code_blocks` 中的硬编码CSS提取到 `styles.py`。
- [ ] **1.4.** 完善TOC功能：实现 `[TOC]` 占位符的替换逻辑。

### **阶段 2: 新功能 - 手动AI润色**
- [ ] **2.1.** 在 `gui` 目录下创建 `polish_dialog.py`。
- [ ] **2.2.** 在 `gui/main_window.py` 中添加触发按钮。
- [ ] **2.3.** 在 `core/llm.py` 中添加支持自定义指令的新方法。
- [ ] **2.4.** 联通前后端，完成功能集成。

### **阶段 3: 核心性能优化 (异步改造)**
- [ ] **3.1.** 在 `requirements.txt` 中添加 `httpx` 并移除 `requests`。
- [ ] **3.2.** 将 `core/wechat_api.py` 中的网络请求改造为 `async`。
- [ ] **3.3.** 将 `core/llm.py` 中的网络请求改造为 `async`。
- [ ] **3.4.** 将 `core/crawler.py` 中的网络请求改造为 `async`。
- [ ] **3.5.** (*此项依赖GUI代码*) 在GUI层面使用 `QThread` 或 `asyncqt` 调用异步API。

### **阶段 4: 健壮性与长期维护**
- [ ] **4.1.** 将 `wechat_api.py` 中的API重试逻辑改为“循环+指数退避”。
- [ ] **4.2.** 为 `media_id` 建立本地缓存机制 (`media_cache.json`)。
- [ ] **4.3.** 引入 `pytest` 并为至少一个核心功能（如 `parser.py`）编写示例单元测试。
- [ ] **4.4.** 将 `requirement.md` 重命名为 `SPECIFICATION.md`。
